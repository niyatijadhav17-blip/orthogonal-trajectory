<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Orthogonal Trajectory Calculator</title>
  <script src="https://cdn.jsdelivr.net/npm/mathjs@11.8.0/lib/browser/math.js"></script>
  <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:18px}
    label{display:block;margin-top:8px}
    input,textarea,select{width:100%;padding:8px;margin-top:4px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    #plot{height:560px;margin-top:12px}
    .hint{font-size:0.9rem;color:#444}
    button{padding:10px 14px;margin-top:10px;border-radius:6px;border:1px solid #ccc;background:#f5f5f5}
  </style>
</head>
<body>
  <h2>Orthogonal Trajectory Calculator (client-side)</h2>
  <p class="hint">Enter a family of curves in the form <code>y = f(x, C)</code> where <code>C</code> is the family parameter. The page will compute orthogonal trajectories numerically by solving the ODE <code>dy/dx = -1 / (∂f/∂x)</code> (treating C as constant when differentiating).</p>

  <label>Family expression for <code>y</code> (use variables <code>x</code> and <code>C</code>)</label>
  <input id="family" value="C*x^2" />

  <div class="row">
    <div>
      <label>Choose parameter C (example values)</label>
      <input id="paramC" value="1" />
    </div>
    <div>
      <label>Initial point for orthogonal trajectory (x0, y0)</label>
      <div style="display:flex;gap:8px"><input id="x0" placeholder="x0" value="1"/><input id="y0" placeholder="y0" value="1"/></div>
    </div>
  </div>

  <div class="row">
    <div>
      <label>Integration range for x (min,max)</label>
      <input id="xrange" value="-5,5" />
    </div>
    <div>
      <label>Step size (smaller = more accurate)</label>
      <input id="step" value="0.01" />
    </div>
  </div>

  <label>Advanced: plot family curves for some C values (comma-separated)</label>
  <input id="familyCs" value="-2,-1,0,1,2" />

  <button id="compute">Compute & Plot</button>
  <div id="messages" class="hint"></div>

  <div id="plot"></div>

  <script>
    const math = window.math;

    function parseNumberList(s){
      return s.split(',').map(t=>parseFloat(t.trim())).filter(n=>!isNaN(n));
    }

    // Simple RK4 integrator for dy/dx = f(x,y)
    function integrateRK4(f, x0, y0, xEnd, h){
      const pts = [];
      const sign = xEnd >= x0 ? 1 : -1;
      const steps = Math.max(1, Math.ceil(Math.abs((xEnd - x0)/h)));
      let x = x0, y = y0;
      pts.push([x,y]);
      for(let i=0;i<steps;i++){
        const dt = sign * Math.abs((xEnd-x0)/steps);
        const k1 = f(x,y);
        const k2 = f(x + dt/2, y + (dt/2)*k1);
        const k3 = f(x + dt/2, y + (dt/2)*k2);
        const k4 = f(x + dt, y + dt*k3);
        y = y + (dt/6)*(k1 + 2*k2 + 2*k3 + k4);
        x = x + dt;
        if(!isFinite(y)) break;
        pts.push([x,y]);
      }
      return pts;
    }

    document.getElementById('compute').addEventListener('click', ()=>{
      const msgs = document.getElementById('messages'); msgs.textContent='';
      const family = document.getElementById('family').value.trim();
      const Cval = parseFloat(document.getElementById('paramC').value);
      const x0 = parseFloat(document.getElementById('x0').value);
      const y0 = parseFloat(document.getElementById('y0').value);
      const [xmin,xmax] = document.getElementById('xrange').value.split(',').map(t=>parseFloat(t.trim()));
      const h = parseFloat(document.getElementById('step').value) || 0.01;
      const familyCs = parseNumberList(document.getElementById('familyCs').value);

      if(!family){ msgs.textContent='Please supply a family expression like "C*x^2" or "C*sqrt(x)".'; return; }

      // Build math.js expression and derivative wrt x
      let expr;
      try{ expr = math.parse(family); }
      catch(e){ msgs.textContent = 'Error parsing family expression: '+e; return; }

      // derivative wrt x (treat C as symbol)
      let dexpr;
      try{ dexpr = math.derivative(expr, 'x'); }
      catch(e){ msgs.textContent = 'Could not differentiate expression wrt x: '+e; return; }

      // compile
      const dexprCompiled = dexpr.compile();
      const exprCompiled = expr.compile();

      // slope of orthogonal trajectory: m_ortho = -1 / (dy/dx_original)
      function orthSlope(x,y){
        // evaluate derivative at (x,C)
        const scope = {x: x, C: Cval};
        let dval;
        try{ dval = dexprCompiled.evaluate(scope); }
        catch(e){ return NaN; }
        if(!isFinite(dval) || Math.abs(dval) < 1e-12) return NaN;
        return -1.0 / dval;
      }

      // Build ODE function for RK4
      const ode = (x,y) => orthSlope(x,y);

      // integrate forward and backward from initial point
      const forward = integrateRK4(ode, x0, y0, xmax, h);
      const backward = integrateRK4(ode, x0, y0, xmin, h).reverse();
      const traj = backward.concat(forward.slice(1));

      // build traces
      const traces = [];

      // family curves (plot by evaluating y = f(x,C) for each C)
      if(familyCs.length){
        for(const c of familyCs){
          const xs = [], ys = [];
          for(let x = xmin; x <= xmax; x += Math.max(Math.abs(h), 0.02)){
            try{
              const v = exprCompiled.evaluate({x:x, C:c});
              if(isFinite(v)){ xs.push(x); ys.push(v); }
            }catch(e){ /* skip */ }
          }
          traces.push({x: xs, y: ys, mode:'lines', name:`family C=${c}`, line:{dash:'dot'}});
        }
      }

      // orthogonal trajectory
      const xsT = traj.map(p=>p[0]);
      const ysT = traj.map(p=>p[1]);
      traces.push({x: xsT, y: ysT, mode:'lines', name:'orthogonal trajectory', line:{width:3}});

      // initial point
      traces.push({x:[x0], y:[y0], mode:'markers', name:'initial point', marker:{size:8}});

      Plotly.newPlot('plot', traces, {margin:{t:30}, title:'Orthogonal Trajectory'});

      msgs.textContent = 'Plotted numerical orthogonal trajectory. Note: this is numeric integration and supports families given as y=f(x,C) only.';
    });

  </script>
</body>
</html>
